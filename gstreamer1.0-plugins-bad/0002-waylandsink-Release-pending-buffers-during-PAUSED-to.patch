From 862b98a61914f56236eaa1c60ba135642f239277 Mon Sep 17 00:00:00 2001
From: Pratik Pachange <ppachang@qti.qualcomm.com>
Date: Thu, 29 Jan 2026 14:50:36 +0530
Subject: [PATCH 2/3] waylandsink: Release pending buffers during PAUSED to
 READY state change

Add functionality to forcibly release any pending buffers in the
wayland compositor at GST_STATE_CHANGE_PAUSED_TO_READY. This is
needed because some live sources may require all buffers to be
returned when transitioning to READY state.

Upstream-Status: Submitted [https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/10386]

Signed-off-by: Bala Sai Kosuri <bkosuri@qti.qualcomm.com>
---
 ext/wayland/gstwaylandsink.c        |  1 +
 gst-libs/gst/wayland/gstwldisplay.c | 16 ++++++++++++++++
 gst-libs/gst/wayland/gstwldisplay.h |  3 +++
 3 files changed, 20 insertions(+)

diff --git a/ext/wayland/gstwaylandsink.c b/ext/wayland/gstwaylandsink.c
index 8b8aba9..946e246 100644
--- a/ext/wayland/gstwaylandsink.c
+++ b/ext/wayland/gstwaylandsink.c
@@ -557,6 +557,7 @@ gst_wayland_sink_change_state (GstElement * element, GstStateChange transition)
         }
       }
 
+      gst_wl_display_force_release_buffers (self->display);
       break;
     case GST_STATE_CHANGE_READY_TO_NULL:
       g_mutex_lock (&self->display_lock);
diff --git a/gst-libs/gst/wayland/gstwldisplay.c b/gst-libs/gst/wayland/gstwldisplay.c
index a12813e..797b397 100644
--- a/gst-libs/gst/wayland/gstwldisplay.c
+++ b/gst-libs/gst/wayland/gstwldisplay.c
@@ -1236,3 +1236,19 @@ gst_wl_display_get_output_by_name (GstWlDisplay * self,
 
   return output;
 }
+
+void
+gst_wl_display_force_release_buffers (GstWlDisplay * self)
+{
+  GstWlDisplayPrivate *priv = gst_wl_display_get_instance_private (self);
+
+  /* to avoid buffers being unregistered from another thread
+   * at the same time, take their ownership */
+  g_mutex_lock (&priv->buffers_mutex);
+  g_hash_table_foreach (priv->buffers, gst_wl_ref_wl_buffer, NULL);
+  g_mutex_unlock (&priv->buffers_mutex);
+
+  g_hash_table_foreach (priv->buffers,
+      (GHFunc) gst_wl_buffer_force_release_and_unref, NULL);
+  g_hash_table_remove_all (priv->buffers);
+}
\ No newline at end of file
diff --git a/gst-libs/gst/wayland/gstwldisplay.h b/gst-libs/gst/wayland/gstwldisplay.h
index ca6e6a9..8d9f669 100644
--- a/gst-libs/gst/wayland/gstwldisplay.h
+++ b/gst-libs/gst/wayland/gstwldisplay.h
@@ -148,4 +148,7 @@ gboolean gst_wl_display_are_color_coefficients_supported (GstWlDisplay * self, u
 GST_WL_API
 GstWlOutput * gst_wl_display_get_output_by_name (GstWlDisplay * self, const gchar * output_name);
 
+GST_WL_API
+void gst_wl_display_force_release_buffers (GstWlDisplay * self);
+
 G_END_DECLS
-- 
2.34.1

